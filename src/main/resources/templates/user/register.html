<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <style>
    .error-message {
      color: red;
      font-size: 0.9em;
    }
    .success-message {
      color: green;
      font-size: 0.9em;
    }
    .info-message {
      color: gray;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
<h1>회원가입</h1>

<!-- 회원가입 성공 메시지 -->
<div th:if="${param.success == 'true'}">
  <p class="success-message">회원가입이 완료되었습니다! 로그인해주세요.</p>
</div>

<!-- 회원가입 실패 메시지 -->
<div th:if="${registrationSuccess == false}">
  <p class="error-message">회원가입 실패: <span th:text="${errorMessage}"></span></p>
</div>

<form th:action="@{/register}" method="post" th:object="${joinRequestDTO}" onsubmit="return validateJoinForm();">
  <div>
    <label for="userId">아이디</label>
    <input type="text" id="userId" th:field="*{userId}" />
    <span th:if="${#fields.hasErrors('userId')}" th:errors="*{userId}" class="error-message"></span>
  </div>

  <div>
    <label for="password">비밀번호</label>
    <input type="password" id="password" th:field="*{password}" oninput="checkPasswordPattern(); checkPasswordMatch();" />
    <div id="patternMessage" class="info-message">비밀번호는 8자 이상, 영문/숫자/특수문자를 포함해야 합니다.</div>
    <span th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="error-message"></span>
  </div>

  <div>
    <label for="passwordCheck">비밀번호 확인</label>
    <input type="password" id="passwordCheck" th:field="*{passwordCheck}" oninput="checkPasswordMatch();" />
    <div id="matchMessage"></div>
    <span th:if="${#fields.hasErrors('passwordCheck')}" th:errors="*{passwordCheck}" class="error-message"></span>
  </div>

  <div>
    <label for="username">이름</label>
    <input type="text" id="username" th:field="*{username}" />
    <span th:if="${#fields.hasErrors('username')}" th:errors="*{username}" class="error-message"></span>
  </div>

  <!-- 이메일 인증 -->
  <div>
    <label for="email">이메일</label>
    <input type="email" id="email" th:field="*{email}" oninput="validateEmail();" />
    <button type="button" onclick="sendVerificationCode()">인증 코드 전송</button>
    <span id="emailValidationMessage" class="error-message"></span>
    <span id="emailSendResult" class="success-message"></span><br/>
    <span th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="error-message"></span>
  </div>

  <div>
    <label for="emailCode">인증 코드</label>
    <input type="text" id="emailCode" />
    <button type="button" onclick="verifyEmailCode()">인증 확인</button>
    <span id="verifyResult" style="color:blue;"></span>
  </div>

  <input type="hidden" name="emailVerified" id="emailVerified" value="false" />

  <div>
    <label for="phoneNumber">전화번호</label>
    <input type="text" id="phoneNumber" th:field="*{phoneNumber}" />
  </div>

  <!-- signupType은 기본 GENERAL 이므로 숨김 처리 -->
  <input type="hidden" th:field="*{signupType}" />

  <div>
    <button type="submit" onclick="return checkEmailVerification()">회원가입</button>
    <button type="reset">새로고침</button>
  </div>
</form>

<script>
  function validateEmail() {
    const email = document.getElementById("email").value;
    const message = document.getElementById("emailValidationMessage");
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!email) {
      message.innerText = "";
    } else if (!emailPattern.test(email)) {
      message.innerText = "올바른 이메일 형식을 입력해주세요.";
    } else {
      message.innerText = "";
    }
  }

  function sendVerificationCode() {
    const email = document.getElementById("email").value;
    const message = document.getElementById("emailValidationMessage");
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!email) {
      alert("이메일을 입력해주세요.");
      return;
    }

    if (!emailPattern.test(email)) {
      message.innerText = "올바른 이메일 형식을 입력해주세요.";
      return;
    }

    fetch("/email/send?email=" + encodeURIComponent(email))
            .then(response => response.text())
            .then(data => {
              document.getElementById("emailSendResult").innerText = "인증 코드가 전송되었습니다.";
            })
            .catch(error => {
              console.error("전송 오류:", error);
              alert("이메일 전송 실패");
            });
  }

  function verifyEmailCode() {
    const email = document.getElementById("email").value;
    const code = document.getElementById("emailCode").value;

    fetch("/email/verify?email=" + encodeURIComponent(email) + "&code=" + encodeURIComponent(code))
            .then(response => response.json())
            .then(result => {
              if (result.verified) {
                document.getElementById("verifyResult").innerText = "인증 완료!";
                document.getElementById("emailVerified").value = "true";
              } else {
                document.getElementById("verifyResult").innerText = "인증 실패. 다시 시도해주세요.";
                document.getElementById("emailVerified").value = "false";
              }
            })
            .catch(error => {
              console.error("인증 오류:", error);
              alert("인증 확인 실패");
            });
  }

  function checkEmailVerification() {
    const verified = document.getElementById("emailVerified").value;
    if (verified !== "true") {
      alert("이메일 인증을 완료해주세요.");
      return false;
    }
    return true;
  }

  function checkPasswordPattern() {
    const newPassword = document.getElementById("password").value;
    const message = document.getElementById("patternMessage");
    const pattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&]).{8,}$/;

    if (!newPassword) {
      message.innerText = "비밀번호는 8자 이상, 영문/숫자/특수문자를 포함해야 합니다.";
      message.className = "info-message";
    } else if (!pattern.test(newPassword)) {
      message.innerText = "비밀번호 형식이 맞지 않습니다. 다시 확인해주세요.";
      message.className = "error-message";
    } else {
      message.innerText = "사용 가능한 비밀번호입니다.";
      message.className = "success-message";
    }
  }

  function checkPasswordMatch() {
    const newPassword = document.getElementById("password").value;
    const confirmPassword = document.getElementById("passwordCheck").value;
    const message = document.getElementById("matchMessage");

    if (!confirmPassword) {
      message.innerText = "";
      message.className = "";
    } else if (newPassword !== confirmPassword) {
      message.innerText = "비밀번호가 일치하지 않습니다.";
      message.className = "error-message";
    } else {
      message.innerText = "비밀번호가 일치합니다.";
      message.className = "success-message";
    }
  }

  function validateJoinForm() {
    checkPasswordPattern();
    checkPasswordMatch();
    validateEmail();

    const patternMessage = document.getElementById("patternMessage").innerText;
    const matchMessage = document.getElementById("matchMessage").innerText;
    const emailMessage = document.getElementById("emailValidationMessage").innerText;

    const isPasswordValid = patternMessage === "사용 가능한 비밀번호입니다.";
    const isPasswordMatch = matchMessage === "비밀번호가 일치합니다.";
    const isEmailValid = emailMessage === "";

    return isPasswordValid && isPasswordMatch && isEmailValid;
  }
</script>
</body>
</html>
